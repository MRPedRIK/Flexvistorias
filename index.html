<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Flex Vistorias - Sistema Corrigido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary:#2c3e50; --secondary:#3498db; --light:#f5f7fa; --white:#fff;
      --muted:#6b7280; --success:#16a34a; --danger:#dc2626; --warning:#d97706;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background:var(--light); color:#111827; display:flex; min-height:100vh; }
    .sidebar { width:260px; background:var(--primary); color:var(--white); padding:16px 0; display:flex; flex-direction:column; }
    .logo { padding:0 20px 16px; margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,.1) }
    .logo h2 { margin:0; font-size:20px; font-weight:700; letter-spacing:.3px; }
    .menu { list-style:none; margin:8px 0 0; padding:0; }
    .menu li { display:flex; align-items:center; gap:10px; padding:10px 18px; cursor:pointer; transition:.2s; border-left:4px solid transparent; }
    .menu li:hover { background:rgba(255,255,255,.08); }
    .menu li.active { background:rgba(255,255,255,.12); border-left-color:#fff; }
    .logout { margin-top:auto; padding:8px 0; border-top:1px solid rgba(255,255,255,.1) }
    .main { flex:1; padding:20px; overflow:auto; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .header h1 { margin:0; font-size:22px; }
    .userbox { display:flex; align-items:center; gap:10px; color:#374151; }
    .avatar { width:36px; height:36px; background:var(--secondary); color:#fff; border-radius:50%; display:grid; place-items:center; font-weight:700; }
    .section { display:none; }
    .section.active { display:block; }
    .cards { display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:12px; margin:16px 0 20px; }
    .card { background:#fff; border-radius:10px; padding:14px; box-shadow:0 1px 4px rgba(0,0,0,.06); }
    .card h4 { margin:0 0 6px; font-size:12px; color:#6b7280; font-weight:600; letter-spacing:.3px; text-transform:uppercase; }
    .card .val { font-size:22px; font-weight:800; }
    .card.success .val { color:var(--success) }
    .card.danger .val { color:var(--danger) }
    .panel { background:#fff; border-radius:10px; padding:16px; box-shadow:0 1px 4px rgba(0,0,0,.06); }
    .panel h3 { margin:0 0 10px; font-size:16px; }
    .row { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; }
    .row-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .row-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .row-1 { grid-template-columns: 1fr; }
    input, select, textarea { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; outline:none; font-size:14px; }
    input:focus, select:focus, textarea:focus { border-color:var(--secondary); box-shadow:0 0 0 3px rgba(52,152,219,.15); }
    .btn { border:0; border-radius:8px; padding:10px 14px; font-weight:700; cursor:pointer; }
    .btn-primary { background:var(--secondary); color:#fff; }
    .btn-success { background:var(--success); color:#fff; }
    .btn-danger { background:var(--danger); color:#fff; }
    .btn-muted { background:#e5e7eb; color:#111827; }
    .btn-warning { background:var(--warning); color:#fff; }
    .actions { display:flex; gap:6px; }
    .list { margin-top:12px; display:grid; gap:8px; }
    .item { border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:10px; display:flex; align-items:center; justify-content:space-between; }
    .item h4 { margin:0 0 4px; font-size:15px; }
    .muted { color:#6b7280; font-size:13px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; text-align:left; border-bottom:1px solid #eee; font-size:14px; }
    thead th { color:#6b7280; font-weight:700; }
    .calendar-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .calendar-grid { display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:6px; }
    .day-name { text-align:center; font-weight:700; color:#6b7280; font-size:12px; }
    .day { border:1px solid #e5e7eb; border-radius:8px; min-height:54px; display:grid; place-items:center; font-weight:700; cursor:pointer; }
    .day.other { color:#9ca3af; }
    .day.today { background:#eff6ff; border-color:#dbeafe; color:#1d4ed8; }
    .day.has-event { background:#ecfdf5; border-color:#bbf7d0; color:#065f46; }
    .checkbox { width:16px; height:16px; }
    .status-badge { padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600; }
    .status-pago { background:#dcfce7; color:#166534; }
    .status-pendente { background:#fef3c7; color:#92400e; }
    .quick-actions { display:flex; gap:10px; margin:10px 0; }
    .search-box { margin-bottom:15px; }
    @media (max-width: 1080px) { .cards { grid-template-columns: repeat(2, minmax(0,1fr)); } .row { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 780px) { .sidebar { width:80px } .menu span { display:none } .logo h2 { font-size:16px } .cards { grid-template-columns: 1fr; } .row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo"><h2>Flex Vistorias</h2></div>
    <ul class="menu">
      <li class="active" onclick="showSection('dashboard', this)"><i class="fa-solid fa-gauge"></i><span>Dashboard</span></li>
      <li onclick="showSection('clientes', this)"><i class="fa-solid fa-users"></i><span>Clientes</span></li>
      <li onclick="showSection('servicos', this)"><i class="fa-solid fa-screwdriver-wrench"></i><span>Serviços</span></li>
      <li onclick="showSection('venda', this)"><i class="fa-solid fa-cash-register"></i><span>Nova Venda</span></li>
      <li onclick="showSection('contas', this)"><i class="fa-solid fa-money-bill-wave"></i><span>Contas a Receber</span></li>
      <li onclick="showSection('agendamento', this)"><i class="fa-regular fa-calendar"></i><span>Agendamentos</span></li>
      <li onclick="showSection('categorias', this)"><i class="fa-solid fa-tags"></i><span>Categorias</span></li>
      <li onclick="showSection('usuarios', this)"><i class="fa-solid fa-user-gear"></i><span>Usuários</span></li>
      <li onclick="showSection('relatorios', this)"><i class="fa-solid fa-chart-column"></i><span>Relatórios</span></li>
      <li onclick="showSection('perfil', this)"><i class="fa-solid fa-user"></i><span>Perfil</span></li>
    </ul>
    <div class="logout">
      <li class="menu" style="list-style:none" onclick="sair()"><div style="display:flex;align-items:center;gap:10px;padding:10px 18px;cursor:pointer"><i class="fa-solid fa-right-from-bracket"></i><span>Sair</span></div></li>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <h1 id="page-title">Dashboard</h1>
      <div class="userbox">
        <div id="notification-count" class="btn btn-danger" style="padding:4px 10px;font-size:12px;">0</div>
        <div id="user-name">Administrador</div>
        <div id="user-avatar" class="avatar">A</div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">
      <div class="cards">
        <div class="card success">
          <h4>Vendas do mês</h4>
          <div id="sales-value" class="val">R$ 0,00</div>
          <div id="sales-footer" class="muted">0 vendas</div>
        </div>
        <div class="card danger">
          <h4>Contas pendentes</h4>
          <div id="pending-value" class="val">0</div>
          <div id="pending-footer" class="muted">Contas a receber</div>
        </div>
        <div class="card">
          <h4>Total de clientes</h4>
          <div id="clients-value" class="val">0</div>
          <div class="muted">Clientes cadastrados</div>
        </div>
        <div class="card">
          <h4>Serviços ativos</h4>
          <div id="services-value" class="val">0</div>
          <div class="muted">Serviços disponíveis</div>
        </div>
        <div class="card">
          <h4>Agendamentos hoje</h4>
          <div id="scheduling-value" class="val">0</div>
          <div class="muted">Para hoje</div>
        </div>
      </div>

      <div class="panel">
        <h3>Vendas mensais</h3>
        <div style="height:260px"><canvas id="salesChart"></canvas></div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="clientes" class="section">
      <div class="panel">
        <h3>Clientes</h3>
        <div class="row row-3">
          <input id="client-name" placeholder="Nome completo *">
          <input id="client-email" placeholder="E-mail">
          <input id="client-phone" placeholder="Telefone">
          <input id="client-document" placeholder="CPF/CNPJ">
          <select id="client-inspection-type">
            <option value="">Tipo de Vistoria</option>
            <option value="1">1 - Vistoria Veicular</option>
            <option value="2">2 - Vistoria Cautelar</option>
            <option value="3">3 - Consulta</option>
          </select>
          <button class="btn btn-primary" onclick="addClient()">Adicionar</button>
          <input id="search-clients" placeholder="Buscar clientes..." oninput="searchClients()">
        </div>
        <div id="clients-container" class="list"></div>
      </div>
    </section>

    <!-- SERVIÇOS -->
    <section id="servicos" class="section">
      <div class="panel">
        <h3>Serviços</h3>
        <div class="row row-3">
          <input id="service-code" placeholder="Código (ex: 001, 002)">
          <input id="service-name" placeholder="Nome do serviço *">
          <input id="service-price" type="number" step="0.01" placeholder="Preço (R$) *">
          <input id="service-cost" type="number" step="0.01" placeholder="Custo (R$) *">
          <input id="service-duration" type="number" placeholder="Duração (min)">
          <select id="service-category"></select>
          <button class="btn btn-primary" onclick="addService()">Adicionar</button>
          <input id="search-services" placeholder="Buscar serviços..." oninput="searchServices()">
        </div>
        <div id="services-container" class="list"></div>
      </div>
    </section>

    <!-- NOVA VENDA - CORRIGIDO -->
    <section id="venda" class="section">
      <div class="panel">
        <h3>Nova venda</h3>
        <div class="row row-3">
          <select id="sale-client"></select>
          <select id="sale-service"></select>
          <input id="sale-vehicle" placeholder="Veículo *">
          <input id="sale-plate" placeholder="Placa *">
          <input id="sale-date" type="date">
          <select id="sale-payment">
            <option value="dinheiro">Dinheiro</option>
            <option value="cartao_credito">Cartão de Crédito</option>
            <option value="cartao_debito">Cartão de Débito</option>
            <option value="pix">PIX</option>
          </select>
          <select id="sale-status">
            <option value="Pago">Pago</option>
            <option value="Pendente" selected>Pendente</option>
          </select>
          <input id="sale-discount" type="number" step="0.01" placeholder="Desconto (R$)">
          <input id="sale-notes" placeholder="Observações">
          <div class="row-1">
            <button class="btn btn-success" onclick="completeSale()">Finalizar venda</button>
            <button class="btn btn-muted" onclick="clearSaleForm()" style="margin-top:5px;">Nova venda (limpar)</button>
          </div>
        </div>

        <div id="sale-summary" class="panel" style="margin-top:12px; display:none;">
          <h3>Resumo da Última Venda</h3>
          <div class="row row-2">
            <div><b>Cliente:</b> <span id="summary-client"></span></div>
            <div><b>Serviço:</b> <span id="summary-service"></span></div>
            <div><b>Veículo:</b> <span id="summary-vehicle"></span></div>
            <div><b>Placa:</b> <span id="summary-plate"></span></div>
            <div><b>Data:</b> <span id="summary-date"></span></div>
            <div><b>Pagamento:</b> <span id="summary-payment"></span></div>
            <div><b>Status:</b> <span id="summary-status"></span></div>
            <div><b>Desconto:</b> <span id="summary-discount"></span></div>
            <div class="row-1"><b>Observações:</b> <span id="summary-notes"></span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTAS A RECEBER - CORRIGIDO -->
    <section id="contas" class="section">
      <div class="panel">
        <h3>Contas a receber</h3>
        
        <div class="search-box">
          <div class="row row-3">
            <input id="search-bills-client" placeholder="Buscar por cliente...">
            <input id="search-bills-vehicle" placeholder="Buscar por veículo...">
            <input id="search-bills-plate" placeholder="Buscar por placa...">
            <input type="date" id="search-bills-date-start" placeholder="Data início">
            <input type="date" id="search-bills-date-end" placeholder="Data fim">
            <select id="search-bills-status">
              <option value="">Todos os status</option>
              <option value="Pago">Pago</option>
              <option value="Pendente">Pendente</option>
            </select>
            <button class="btn btn-primary" onclick="searchBills()">Buscar</button>
            <button class="btn btn-muted" onclick="clearBillSearch()">Limpar</button>
          </div>
        </div>

        <div class="quick-actions">
          <button class="btn btn-success" onclick="receiveSelectedBills()">Receber selecionadas</button>
          <button class="btn btn-warning" onclick="selectAllBills()">Selecionar todas</button>
          <button class="btn btn-muted" onclick="deselectAllBills()">Desmarcar todas</button>
        </div>

        <table>
          <thead>
            <tr>
              <th width="30"><input type="checkbox" id="select-all-bills" onchange="toggleSelectAllBills(this)"></th>
              <th>Venda</th>
              <th>Cliente</th>
              <th>Veículo</th>
              <th>Placa</th>
              <th>Serviço</th>
              <th>Data</th>
              <th>Valor</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="bills-table-body"></tbody>
        </table>
      </div>
    </section>

    <!-- AGENDAMENTOS -->
    <section id="agendamento" class="section">
      <div class="panel">
        <h3>Agendamentos</h3>
        <div class="row row-3">
          <select id="scheduling-client"></select>
          <select id="scheduling-service"></select>
          <input id="scheduling-date" type="date">
          <input id="scheduling-time" type="time">
          <input id="scheduling-notes" placeholder="Observações">
          <button class="btn btn-primary" onclick="addScheduling()">Agendar</button>
        </div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="calendar-head">
          <button class="btn btn-muted" onclick="prevMonth()"><i class="fa-solid fa-chevron-left"></i></button>
          <div id="current-month" style="font-weight:800"></div>
          <button class="btn btn-muted" onclick="nextMonth()"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
        <div class="calendar-grid" id="calendar-weekdays">
          <div class="day-name">Dom</div><div class="day-name">Seg</div><div class="day-name">Ter</div><div class="day-name">Qua</div><div class="day-name">Qui</div><div class="day-name">Sex</div><div class="day-name">Sáb</div>
        </div>
        <div class="calendar-grid" id="calendar-days"></div>
      </div>

      <div class="panel" style="margin-top:12px;">
        <div class="search-box">
          <div class="row">
            <input id="search-scheduling" placeholder="Buscar agendamentos por cliente, serviço ou observações..." oninput="searchScheduling()">
          </div>
        </div>
        <div id="scheduling-container" class="list"></div>
      </div>
    </section>

    <!-- CATEGORIAS -->
    <section id="categorias" class="section">
      <div class="panel">
        <h3>Categorias</h3>
        <div class="row row-3">
          <input id="category-name" placeholder="Nome da categoria">
          <input id="category-description" placeholder="Descrição (opcional)">
          <button class="btn btn-primary" onclick="addCategory()">Adicionar</button>
        </div>
        <div id="categories-container" class="list"></div>
      </div>
    </section>

    <!-- USUÁRIOS -->
    <section id="usuarios" class="section">
      <div class="panel">
        <h3>Usuários</h3>
        <div class="row row-3">
          <input id="user-name" placeholder="Nome">
          <input id="user-email" placeholder="E-mail">
          <input id="user-password" type="password" placeholder="Senha">
          <select id="user-role">
            <option value="admin">Administrador</option>
            <option value="manager">Gerente</option>
            <option value="attendant">Atendente</option>
            <option value="viewer">Visualizador</option>
          </select>
          <button class="btn btn-primary" onclick="addUser()">Adicionar</button>
        </div>
        <div id="users-container" class="list"></div>
      </div>
    </section>

    <!-- RELATÓRIOS - CORRIGIDO -->
    <section id="relatorios" class="section">
      <div class="panel">
        <h3>Relatório de vendas</h3>
        <div class="row row-3">
          <input id="report-sales-date-start" type="date">
          <input id="report-sales-date-end" type="date">
          <select id="report-sales-client">
            <option value="">Todos os clientes</option>
          </select>
          <select id="report-sales-service">
            <option value="">Todos os serviços</option>
          </select>
          <select id="report-sales-status">
            <option value="">Todos os status</option>
            <option value="Pago">Pago</option>
            <option value="Pendente">Pendente</option>
          </select>
          <button class="btn btn-primary" onclick="generateSalesReport()">Gerar Relatório</button>
          <button class="btn btn-muted" onclick="window.print()">Imprimir</button>
          <button class="btn btn-success" onclick="exportToExcel()">Exportar Excel</button>
        </div>
        
        <div style="height:260px; margin-top:20px;">
          <canvas id="salesReportChart"></canvas>
        </div>
        
        <table style="margin-top:20px">
          <thead>
            <tr>
              <th>Data</th>
              <th>Cliente</th>
              <th>Veículo</th>
              <th>Placa</th>
              <th>Serviço</th>
              <th>Valor</th>
              <th>Status</th>
              <th>Pagamento</th>
            </tr>
          </thead>
          <tbody id="sales-report-body"></tbody>
        </table>
        
        <div style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px;">
          <h4>Resumo do Relatório</h4>
          <div class="row row-3">
            <div><strong>Total de Vendas:</strong> <span id="report-total-sales">0</span></div>
            <div><strong>Valor Total:</strong> <span id="report-total-value">R$ 0,00</span></div>
            <div><strong>Valor Pendente:</strong> <span id="report-pending-value">R$ 0,00</span></div>
            <div><strong>Valor Recebido:</strong> <span id="report-received-value">R$ 0,00</span></div>
            <div><strong>Ticket Médio:</strong> <span id="report-average-ticket">R$ 0,00</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- PERFIL -->
    <section id="perfil" class="section">
      <div class="panel">
        <h3>Meu perfil</h3>
        <div class="row row-3">
          <input id="profile-name" placeholder="Nome">
          <input id="profile-email" placeholder="E-mail">
          <input id="profile-phone" placeholder="Telefone">
          <input id="profile-password" type="password" placeholder="Nova senha (opcional)">
          <input id="profile-password-confirm" type="password" placeholder="Confirmar nova senha">
          <button class="btn btn-primary" onclick="updateProfile()">Salvar</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Estado
    let clients = JSON.parse(localStorage.getItem('clients')) || [];
    let services = JSON.parse(localStorage.getItem('services')) || [];
    let categories = JSON.parse(localStorage.getItem('categories')) || [];
    let sales = JSON.parse(localStorage.getItem('sales')) || [];
    let users = JSON.parse(localStorage.getItem('users')) || [{ id:1, name:"Administrador", email:"admin@flexvistorias.com", password:"admin123", role:"admin", phone:"(11) 99999-9999" }];
    let schedulings = JSON.parse(localStorage.getItem('schedulings')) || [];
    let currentUser = users[0];
    let currentDate = new Date();
    let salesChart = null;
    let lastSaleId = null; // Prevenir duplicação

    // Helpers
    const save = {
      clients:()=>localStorage.setItem('clients', JSON.stringify(clients)),
      services:()=>localStorage.setItem('services', JSON.stringify(services)),
      categories:()=>localStorage.setItem('categories', JSON.stringify(categories)),
      sales:()=>localStorage.setItem('sales', JSON.stringify(sales)),
      users:()=>localStorage.setItem('users', JSON.stringify(users)),
      schedulings:()=>localStorage.setItem('schedulings', JSON.stringify(schedulings)),
    };
    
    const byId = (id)=>document.getElementById(id);
    const currency = (v)=>`R$ ${Number(v||0).toFixed(2).replace('.', ',')}`;
    const todayISO = ()=> new Date().toISOString().split('T')[0];
    const formatDate = (d)=>{ 
      if(!d) return ''; 
      const s = d.includes('T') ? d.split('T')[0] : d; 
      const [y,m,da] = s.split('-'); 
      return `${da}/${m}/${y}`; 
    };

    // Navegação
    function showSection(id, el){
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      byId(id).classList.add('active');
      document.querySelectorAll('.menu li').forEach(i=>i.classList.remove('active'));
      if(el) el.classList.add('active');
      
      const label = el?.querySelector('span')?.textContent || 'Dashboard';
      byId('page-title').textContent = label;

      // Carregar dados específicos de cada seção
      if(id==='dashboard') updateDashboard();
      if(id==='clientes') loadClients();
      if(id==='servicos'){ loadCategoriesForServices(); loadServices(); }
      if(id==='venda'){ 
        loadClientsForSale(); 
        loadServicesForSale(); 
        clearSaleForm(); // SEMPRE limpar ao abrir nova venda
      }
      if(id==='contas') loadBills();
      if(id==='agendamento'){ loadSchedulingFormOptions(); loadSchedulingCalendar(); loadSchedulingList(); }
      if(id==='categorias') loadCategories();
      if(id==='usuarios') loadUsers();
      if(id==='relatorios'){ loadReportFilters(); generateSalesReport(); }
      if(id==='perfil') fillProfile();
    }

    // Dashboard
    function updateDashboard(){
      const totalSales = sales.reduce((t,s)=>{
        const svc = services.find(x=>x.id===s.serviceId);
        return t + (svc ? parseFloat(svc.price) : 0);
      },0);
      
      const pendingBills = sales.filter(s=>s.status!=='Pago').length;
      const todaySchedulings = schedulings.filter(s=>{
        const d = new Date(s.date);
        const t = new Date();
        return d.toDateString() === t.toDateString();
      }).length;

      byId('sales-value').textContent = currency(totalSales);
      byId('sales-footer').textContent = `${sales.length} vendas`;
      byId('pending-value').textContent = pendingBills;
      byId('clients-value').textContent = clients.length;
      byId('services-value').textContent = services.length;
      byId('scheduling-value').textContent = todaySchedulings;

      updateSalesChart();
    }

    function updateSalesChart(){
      const ctx = byId('salesChart').getContext('2d');
      const monthTotals = Array(12).fill(0);
      
      sales.forEach(s=>{
        const d = new Date(s.date); 
        const svc = services.find(x=>x.id===s.serviceId);
        if(!isNaN(d) && svc) monthTotals[d.getMonth()] += parseFloat(svc.price||0);
      });
      
      if(salesChart) salesChart.destroy();
      
      salesChart = new Chart(ctx, {
        type:'line',
        data:{ 
          labels:['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
          datasets:[{ 
            data:monthTotals, 
            borderColor:'#3498db', 
            backgroundColor:'rgba(52,152,219,.15)', 
            fill:true, 
            tension:.3 
          }] 
        },
        options:{ 
          responsive:true, 
          plugins:{ legend:{display:false} }, 
          scales:{ y:{ beginAtZero:true } } 
        }
      });
    }

    // Clientes
    function addClient(){
      const name = byId('client-name').value.trim();
      const email = byId('client-email').value.trim();
      const phone = byId('client-phone').value.trim();
      const document = byId('client-document').value.trim();
      const inspectionType = byId('client-inspection-type').value;
      
      if(!name) return alert('Informe o nome do cliente');
      
      const newClient = { 
        id: Date.now(), 
        name, 
        email, 
        phone, 
        document, 
        inspectionType,
        createdAt: new Date().toISOString() 
      };
      
      clients.push(newClient);
      save.clients();
      
      // Limpar campos
      byId('client-name').value = '';
      byId('client-email').value = '';
      byId('client-phone').value = '';
      byId('client-document').value = '';
      byId('client-inspection-type').selectedIndex = 0;
      
      loadClients();
      updateDashboard();
      alert('Cliente adicionado com sucesso!');
    }

    function loadClients(list = null){
      const container = byId('clients-container');
      container.innerHTML = '';
      
      const clientsToShow = list || clients;
      
      if(clientsToShow.length === 0){
        container.innerHTML = '<div class="item"><div><h4>Nenhum cliente cadastrado</h4></div></div>';
        return;
      }
      
      clientsToShow.forEach(client => {
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <div>
            <h4>${client.name}</h4>
            <div class="muted">
              ${client.email || 'Sem e-mail'} | ${client.phone || 'Sem telefone'} | ${client.document || 'Sem documento'}
              ${client.inspectionType ? ` | Tipo: ${client.inspectionType}` : ''}
            </div>
          </div>
          <div class="actions">
            <button class="btn btn-muted" onclick="editClient(${client.id})">Editar</button>
            <button class="btn btn-danger" onclick="deleteClient(${client.id})">Excluir</button>
          </div>
        `;
        container.appendChild(item);
      });
    }

    function searchClients(){
      const query = byId('search-clients').value.toLowerCase().trim();
      
      if(!query){
        loadClients();
        return;
      }
      
      const filtered = clients.filter(client => 
        client.name.toLowerCase().includes(query) ||
        (client.email && client.email.toLowerCase().includes(query)) ||
        (client.phone && client.phone.toLowerCase().includes(query)) ||
        (client.document && client.document.toLowerCase().includes(query))
      );
      
      loadClients(filtered);
    }

    // Serviços
    function loadCategoriesForServices(){
      const select = byId('service-category');
      select.innerHTML = '<option value="">Selecione uma categoria</option>';
      
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.name;
        select.appendChild(option);
      });
    }

    function addService(){
      const code = byId('service-code').value.trim();
      const name = byId('service-name').value.trim();
      const price = parseFloat(byId('service-price').value);
      const cost = parseFloat(byId('service-cost').value);
      const duration = parseInt(byId('service-duration').value) || null;
      const categoryId = byId('service-category').value || null;
      
      if(!name || isNaN(price) || isNaN(cost)) {
        return alert('Preencha nome, preço e custo do serviço');
      }
      
      const newService = {
        id: Date.now(),
        code,
        name,
        price,
        cost,
        duration,
        categoryId,
        createdAt: new Date().toISOString()
      };
      
      services.push(newService);
      save.services();
      
      // Limpar campos
      byId('service-code').value = '';
      byId('service-name').value = '';
      byId('service-price').value = '';
      byId('service-cost').value = '';
      byId('service-duration').value = '';
      byId('service-category').selectedIndex = 0;
      
      loadServices();
      updateDashboard();
      alert('Serviço adicionado com sucesso!');
    }

    function loadServices(list = null){
      const container = byId('services-container');
      container.innerHTML = '';
      
      const servicesToShow = list || services;
      
      if(servicesToShow.length === 0){
        container.innerHTML = '<div class="item"><div><h4>Nenhum serviço cadastrado</h4></div></div>';
        return;
      }
      
      servicesToShow.forEach(service => {
        const category = categories.find(c => c.id === service.categoryId);
        const item = document.createElement('div');
        item.className = 'item';
        item.innerHTML = `
          <div>
            <h4>${service.code ? service.code + ' - ' : ''}${service.name}</h4>
            <div class="muted">
              Preço: ${currency(service.price)} | Custo: ${currency(service.cost)} | 
              ${service.duration ? service.duration + 'min' : 'Duração não definida'} |
              ${category ? category.name : 'Sem categoria'}
            </div>
          </div>
          <div class="actions">
            <button class="btn btn-muted" onclick="editService(${service.id})">Editar</button>
            <button class="btn btn-danger" onclick="deleteService(${service.id})">Excluir</button>
          </div>
        `;
        container.appendChild(item);
      });
    }

    function searchServices(){
      const query = byId('search-services').value.toLowerCase().trim();
      
      if(!query){
        loadServices();
        return;
      }
      
      const filtered = services.filter(service => 
        service.name.toLowerCase().includes(query) ||
        (service.code && service.code.toLowerCase().includes(query))
      );
      
      loadServices(filtered);
    }

    // VENDAS - CORRIGIDO (Problema principal)
    function loadClientsForSale(){
      const select = byId('sale-client');
      select.innerHTML = '<option value="">Selecione um cliente</option>';
      
      clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = client.name;
        select.appendChild(option);
      });
    }

    function loadServicesForSale(){
      const select = byId('sale-service');
      select.innerHTML = '<option value="">Selecione um serviço</option>';
      
      services.forEach(service => {
        const option = document.createElement('option');
        option.value = service.id;
        option.textContent = `${service.name} - ${currency(service.price)}`;
        select.appendChild(option);
      });
    }

    function clearSaleForm(){
      byId('sale-client').selectedIndex = 0;
      byId('sale-service').selectedIndex = 0;
      byId('sale-vehicle').value = '';
      byId('sale-plate').value = '';
      byId('sale-date').value = todayISO();
      byId('sale-payment').selectedIndex = 0;
      byId('sale-status').selectedIndex = 1; // Pendente
      byId('sale-discount').value = '';
      byId('sale-notes').value = '';
      lastSaleId = null; // Resetar prevenção de duplicação
    }

    function completeSale(){
      // Prevenir duplicação de vendas
      const currentTimestamp = Date.now();
      if(lastSaleId && (currentTimestamp - lastSaleId) < 3000) {
        return alert('Aguarde alguns segundos antes de fazer outra venda!');
      }

      const clientId = parseInt(byId('sale-client').value);
      const serviceId = parseInt(byId('sale-service').value);
      const vehicle = byId('sale-vehicle').value.trim();
      const plate = byId('sale-plate').value.trim();
      const date = byId('sale-date').value || todayISO();
      const payment = byId('sale-payment').value;
      const status = byId('sale-status').value;
      const discount = parseFloat(byId('sale-discount').value) || 0;
      const notes = byId('sale-notes').value.trim();
      
      // Validações reforçadas
      if(!clientId || !serviceId) {
        return alert('Selecione um cliente e um serviço');
      }
      
      if(!vehicle || !plate) {
        return alert('Informe o veículo e a placa');
      }
      
      const service = services.find(s => s.id === serviceId);
      if(!service) return alert('Serviço não encontrado');
      
      const total = service.price - discount;
      
      const newSale = {
        id: currentTimestamp,
        clientId,
        serviceId,
        vehicle,
        plate,
        date,
        payment,
        status,
        discount,
        total,
        notes,
        createdAt: new Date().toISOString()
      };
      
      sales.push(newSale);
      save.sales();
      lastSaleId = currentTimestamp; // Registrar última venda
      
      // Mostrar resumo
      const client = clients.find(c => c.id === clientId);
      byId('summary-client').textContent = client.name;
      byId('summary-service').textContent = `${service.name} - ${currency(service.price)}`;
      byId('summary-vehicle').textContent = vehicle;
      byId('summary-plate').textContent = plate;
      byId('summary-date').textContent = formatDate(date);
      byId('summary-payment').textContent = payment;
      byId('summary-status').textContent = status;
      byId('summary-discount').textContent = currency(discount);
      byId('summary-notes').textContent = notes || 'Nenhuma';
      byId('sale-summary').style.display = 'block';
      
      // Limpar campos automaticamente para nova venda
      clearSaleForm();
      
      updateDashboard();
      alert('Venda registrada com sucesso! Status: ' + status);
    }

    // CONTAS A RECEBER - CORRIGIDO
    function loadBills(){
      const tbody = byId('bills-table-body');
      tbody.innerHTML = '';
      
      sales.forEach(sale => {
        const client = clients.find(c => c.id === sale.clientId);
        const service = services.find(s => s.id === sale.serviceId);
        
        if(!client || !service) return;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="bill-checkbox" value="${sale.id}"></td>
          <td>#${sale.id}</td>
          <td>${client.name}</td>
          <td>${sale.vehicle || 'Não informado'}</td>
          <td>${sale.plate || 'Não informada'}</td>
          <td>${service.name}</td>
          <td>${formatDate(sale.date)}</td>
          <td>${currency(sale.total)}</td>
          <td><span class="status-badge ${sale.status === 'Pago' ? 'status-pago' : 'status-pendente'}">${sale.status}</span></td>
          <td>
            <button class="btn btn-success" onclick="receiveBill(${sale.id})" ${sale.status === 'Pago' ? 'disabled' : ''}>Receber</button>
            <button class="btn btn-muted" onclick="editBill(${sale.id})">Editar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function searchBills(){
      const clientQuery = byId('search-bills-client').value.toLowerCase().trim();
      const vehicleQuery = byId('search-bills-vehicle').value.toLowerCase().trim();
      const plateQuery = byId('search-bills-plate').value.toLowerCase().trim();
      const dateStart = byId('search-bills-date-start').value;
      const dateEnd = byId('search-bills-date-end').value;
      const statusQuery = byId('search-bills-status').value;
      
      const filtered = sales.filter(sale => {
        const client = clients.find(c => c.id === sale.clientId);
        const matchesClient = !clientQuery || (client && client.name.toLowerCase().includes(clientQuery));
        const matchesVehicle = !vehicleQuery || sale.vehicle.toLowerCase().includes(vehicleQuery);
        const matchesPlate = !plateQuery || sale.plate.toLowerCase().includes(plateQuery);
        const matchesDateStart = !dateStart || sale.date >= dateStart;
        const matchesDateEnd = !dateEnd || sale.date <= dateEnd;
        const matchesStatus = !statusQuery || sale.status === statusQuery;
        
        return matchesClient && matchesVehicle && matchesPlate && matchesDateStart && matchesDateEnd && matchesStatus;
      });
      
      // Recarregar tabela com resultados filtrados
      const tbody = byId('bills-table-body');
      tbody.innerHTML = '';
      
      filtered.forEach(sale => {
        const client = clients.find(c => c.id === sale.clientId);
        const service = services.find(s => s.id === sale.serviceId);
        
        if(!client || !service) return;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="bill-checkbox" value="${sale.id}"></td>
          <td>#${sale.id}</td>
          <td>${client.name}</td>
          <td>${sale.vehicle || 'Não informado'}</td>
          <td>${sale.plate || 'Não informada'}</td>
          <td>${service.name}</td>
          <td>${formatDate(sale.date)}</td>
          <td>${currency(sale.total)}</td>
          <td><span class="status-badge ${sale.status === 'Pago' ? 'status-pago' : 'status-pendente'}">${sale.status}</span></td>
          <td>
            <button class="btn btn-success" onclick="receiveBill(${sale.id})" ${sale.status === 'Pago' ? 'disabled' : ''}>Receber</button>
            <button class="btn btn-muted" onclick="editBill(${sale.id})">Editar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function clearBillSearch(){
      byId('search-bills-client').value = '';
      byId('search-bills-vehicle').value = '';
      byId('search-bills-plate').value = '';
      byId('search-bills-date-start').value = '';
      byId('search-bills-date-end').value = '';
      byId('search-bills-status').selectedIndex = 0;
      loadBills();
    }

    function toggleSelectAllBills(checkbox){
      const checkboxes = document.querySelectorAll('.bill-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });
    }

    function selectAllBills(){
      const checkboxes = document.querySelectorAll('.bill-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = true;
      });
      byId('select-all-bills').checked = true;
    }

    function deselectAllBills(){
      const checkboxes = document.querySelectorAll('.bill-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = false;
      });
      byId('select-all-bills').checked = false;
    }

    function receiveSelectedBills(){
      const checkboxes = document.querySelectorAll('.bill-checkbox:checked');
      if(checkboxes.length === 0) {
        return alert('Selecione pelo menos uma conta para receber');
      }
      
      if(!confirm(`Deseja marcar ${checkboxes.length} conta(s) como recebida(s)?`)) return;
      
      checkboxes.forEach(checkbox => {
        const saleId = parseInt(checkbox.value);
        const sale = sales.find(s => s.id === saleId);
        if(sale) {
          sale.status = 'Pago';
        }
      });
      
      save.sales();
      loadBills();
      updateDashboard();
      alert(`${checkboxes.length} conta(s) marcada(s) como recebida(s)!`);
    }

    function receiveBill(id){
      const sale = sales.find(s => s.id === id);
      if(!sale) return;
      
      sale.status = 'Pago';
      save.sales();
      loadBills();
      updateDashboard();
      alert('Conta marcada como recebida!');
    }

    function editBill(id){
      const sale = sales.find(s => s.id === id);
      if(!sale) return;
      
      const newStatus = prompt('Novo status (Pago/Pendente):', sale.status);
      if(newStatus === null) return;
      
      if(newStatus !== 'Pago' && newStatus !== 'Pendente') {
        return alert('Status deve ser "Pago" ou "Pendente"');
      }
      
      sale.status = newStatus;
      save.sales();
      loadBills();
      updateDashboard();
      alert('Status da conta atualizado!');
    }

    // RELATÓRIOS - CORRIGIDO
    function loadReportFilters(){
      // Carregar clientes
      const clientSelect = byId('report-sales-client');
      clientSelect.innerHTML = '<option value="">Todos os clientes</option>';
      clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = client.name;
        clientSelect.appendChild(option);
      });
      
      // Carregar serviços
      const serviceSelect = byId('report-sales-service');
      serviceSelect.innerHTML = '<option value="">Todos os serviços</option>';
      services.forEach(service => {
        const option = document.createElement('option');
        option.value = service.id;
        option.textContent = service.name;
        serviceSelect.appendChild(option);
      });
    }

    function generateSalesReport(){
      const startDate = byId('report-sales-date-start').value;
      const endDate = byId('report-sales-date-end').value;
      const clientId = byId('report-sales-client').value;
      const serviceId = byId('report-sales-service').value;
      const status = byId('report-sales-status').value;
      
      let filteredSales = sales;
      
      // Aplicar filtros
      if(startDate) filteredSales = filteredSales.filter(s => s.date >= startDate);
      if(endDate) filteredSales = filteredSales.filter(s => s.date <= endDate);
      if(clientId) filteredSales = filteredSales.filter(s => s.clientId === parseInt(clientId));
      if(serviceId) filteredSales = filteredSales.filter(s => s.serviceId === parseInt(serviceId));
      if(status) filteredSales = filteredSales.filter(s => s.status === status);
      
      // Atualizar tabela
      const tbody = byId('sales-report-body');
      tbody.innerHTML = '';
      
      filteredSales.forEach(sale => {
        const client = clients.find(c => c.id === sale.clientId);
        const service = services.find(s => s.id === sale.serviceId);
        
        if(!client || !service) return;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(sale.date)}</td>
          <td>${client.name}</td>
          <td>${sale.vehicle || 'Não informado'}</td>
          <td>${sale.plate || 'Não informada'}</td>
          <td>${service.name}</td>
          <td>${currency(sale.total)}</td>
          <td><span class="status-badge ${sale.status === 'Pago' ? 'status-pago' : 'status-pendente'}">${sale.status}</span></td>
          <td>${sale.payment}</td>
        `;
        tbody.appendChild(tr);
      });
      
      // Atualizar resumo
      updateReportSummary(filteredSales);
      
      // Atualizar gráfico
      updateSalesReportChart(filteredSales);
    }

    function updateReportSummary(salesData){
      const totalSales = salesData.length;
      const totalValue = salesData.reduce((sum, sale) => sum + sale.total, 0);
      const pendingValue = salesData.filter(s => s.status === 'Pendente').reduce((sum, sale) => sum + sale.total, 0);
      const receivedValue = salesData.filter(s => s.status === 'Pago').reduce((sum, sale) => sum + sale.total, 0);
      const averageTicket = totalSales > 0 ? totalValue / totalSales : 0;
      
      byId('report-total-sales').textContent = totalSales;
      byId('report-total-value').textContent = currency(totalValue);
      byId('report-pending-value').textContent = currency(pendingValue);
      byId('report-received-value').textContent = currency(receivedValue);
      byId('report-average-ticket').textContent = currency(averageTicket);
    }

    function updateSalesReportChart(salesData){
      const ctx = byId('salesReportChart').getContext('2d');
      
      // Agrupar por mês
      const monthlyData = {};
      const statusData = { 'Pago': 0, 'Pendente': 0 };
      
      salesData.forEach(sale => {
        const date = new Date(sale.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        
        if(!monthlyData[monthKey]){
          monthlyData[monthKey] = 0;
        }
        
        monthlyData[monthKey] += sale.total;
        statusData[sale.status] += sale.total;
      });
      
      const labels = Object.keys(monthlyData).sort();
      const data = labels.map(label => monthlyData[label]);
      
      if(window.salesReportChart){
        window.salesReportChart.destroy();
      }
      
      window.salesReportChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Vendas por Mês',
            data: data,
            backgroundColor: 'rgba(52, 152, 219, 0.6)',
            borderColor: 'rgba(52, 152, 219, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function exportToExcel(){
      // Simulação de exportação para Excel
      alert('Funcionalidade de exportação para Excel será implementada em breve!');
    }

    // Inicialização
    function init(){
      // Configurar datas padrão
      byId('sale-date').value = todayISO();
      byId('scheduling-date').value = todayISO();
      byId('scheduling-time').value = '09:00';
      
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      byId('report-sales-date-start').value = firstDay.toISOString().split('T')[0];
      byId('report-sales-date-end').value = todayISO();
      
      // Carregar dados iniciais
      updateDashboard();
      loadClients();
      loadServices();
      loadCategories();
      loadUsers();
      loadBills();
      loadReportFilters();
      loadSchedulingFormOptions();
      loadSchedulingCalendar();
      loadSchedulingList();
      
      // Configurar usuário atual
      byId('user-name').textContent = currentUser.name;
      byId('user-avatar').textContent = currentUser.name.charAt(0);
      fillProfile();
    }

    // Iniciar aplicação
    window.onload = init;

    // Funções globais
    window.showSection = showSection;
    window.addClient = addClient;
    window.editClient = editClient;
    window.deleteClient = deleteClient;
    window.searchClients = searchClients;
    window.addService = addService;
    window.editService = editService;
    window.deleteService = deleteService;
    window.searchServices = searchServices;
    window.completeSale = completeSale;
    window.clearSaleForm = clearSaleForm;
    window.receiveBill = receiveBill;
    window.editBill = editBill;
    window.searchBills = searchBills;
    window.clearBillSearch = clearBillSearch;
    window.toggleSelectAllBills = toggleSelectAllBills;
    window.selectAllBills = selectAllBills;
    window.deselectAllBills = deselectAllBills;
    window.receiveSelectedBills = receiveSelectedBills;
    window.generateSalesReport = generateSalesReport;
    window.exportToExcel = exportToExcel;
    window.sair = sair;
  </script>
</body>
</html>
